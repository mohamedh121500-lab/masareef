<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f5f5f5; font-family: sans-serif; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hide { display: none !important; }
        
        .money-plus { color: #198754; font-weight: bold; }
        .money-minus { color: #dc3545; font-weight: bold; }
        .big-number { font-size: 2rem; font-weight: bold; text-align: center; margin: 10px 0; }
        
        .item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .del-btn { background: none; border: none; color: red; font-weight: bold; cursor: pointer; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body>

    <h2 class="text-center mb-4">âœ… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>

    <div class="card">
        <label>ğŸ’° Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª</label>
        <input type="number" id="salaryInput" class="form-control text-center" style="font-size: 1.5rem;" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§ØªØ¨" oninput="saveData()">
    </div>

    <div class="row text-center mb-3">
        <div class="col-4">
            <div class="card p-2">
                <small>Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ</small>
                <div id="showIncome" class="money-plus">0</div>
            </div>
        </div>
        <div class="col-4">
            <div class="card p-2">
                <small>Ù…ØµØ§Ø±ÙŠÙ</small>
                <div id="showExpense" class="money-minus">0</div>
            </div>
        </div>
        <div class="col-4">
            <div class="card p-2">
                <small>Ø§Ù„ØµØ§ÙÙŠ</small>
                <div id="showNet">0</div>
            </div>
        </div>
    </div>

    <div class="big-number" id="finalBalance">0 Ø¬.Ù…</div>

    <div class="card">
        <h5 class="text-center mb-3">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
        <div class="row">
            <div class="col-md-6 mb-4">
                <h6 class="text-center text-danger">Ø£ÙƒØ«Ø± Ø¨Ù†Ø¯ Ø¨ØªØµØ±Ù ÙÙŠÙ‡</h6>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div id="noExpData" class="text-center text-muted mt-5 hide">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>
            </div>
            
            <div class="col-md-6">
                <h6 class="text-center text-success">Ø£ÙƒØ«Ø± Ù…ØµØ¯Ø± Ù„Ù„Ø¯Ø®Ù„</h6>
                <div class="chart-container">
                    <canvas id="incomeChart"></canvas>
                </div>
                <div id="noIncData" class="text-center text-muted mt-5 hide">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¹Ø±Ø¶Ù‡</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h5>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h5>
        
        <div class="btn-group w-100 mb-3" role="group">
            <input type="radio" class="btn-check" name="opType" id="radioExp" value="expense" checked onchange="toggleLists()">
            <label class="btn btn-outline-danger" for="radioExp">ğŸ“¤ Ù…ØµØ±ÙˆÙ</label>

            <input type="radio" class="btn-check" name="opType" id="radioInc" value="income" onchange="toggleLists()">
            <label class="btn btn-outline-success" for="radioInc">ğŸ“¥ Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ</label>
        </div>

        <div class="row g-2">
            <div class="col-6">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="inpAmount" class="form-control" placeholder="0">
            </div>

            <div class="col-6">
                <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                
                <select id="listExpense" class="form-select">
                    <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">ğŸš• Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                    <option value="Ø·Ø¹Ø§Ù…">ğŸ” Ø·Ø¹Ø§Ù…</option>
                    <option value="Ø¹Ù„Ø§Ø¬">ğŸ’Š Ø¹Ù„Ø§Ø¬</option>
                    <option value="Ù…Ù„Ø§Ø¨Ø³">ğŸ‘• Ù…Ù„Ø§Ø¨Ø³</option>
                    <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ğŸ’¡ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                    <option value="ØºØ§Ø²">ğŸ”¥ ØºØ§Ø²</option>
                    <option value="Ù…ÙŠØ§Ù‡">ğŸ’§ Ù…ÙŠØ§Ù‡</option>
                    <option value="Ø§ØµÙ„Ø§Ø­Ø§Øª">ğŸ”§ Ø§ØµÙ„Ø§Ø­Ø§Øª</option>
                    <option value="ØªØ±ÙÙŠÙ‡">ğŸ‰ ØªØ±ÙÙŠÙ‡</option>
                    <option value="Ø£Ø®Ø±Ù‰">ğŸ”¹ Ø£Ø®Ø±Ù‰</option>
                </select>

                <select id="listIncome" class="form-select hide">
                    <option value="Ø¯Ù„ÙŠÙØ±ÙŠ">ğŸ›µ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
                    <option value="ÙØ±ÙŠ Ù„Ø§Ù†Ø³">ğŸ’» ÙØ±ÙŠ Ù„Ø§Ù†Ø³</option>
                    <option value="Ù…ÙƒØ§ÙØ£Ø©">ğŸ Ù…ÙƒØ§ÙØ£Ø©</option>
                    <option value="Ø­ÙˆØ§ÙØ²">ğŸ“ˆ Ø­ÙˆØ§ÙØ²</option>
                    <option value="Ø£Ø®Ø±Ù‰">ğŸ”¹ Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>
        </div>

        <label class="mt-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input type="date" id="inpDate" class="form-control mb-3">

        <button onclick="addTransaction()" class="btn btn-dark w-100">Ø­ÙØ¸</button>
    </div>

    <div class="card">
        <div class="d-flex justify-content-between mb-2">
            <h5>ğŸ“ Ø§Ù„Ø³Ø¬Ù„</h5>
            <button onclick="clearAll()" class="btn btn-sm btn-outline-danger">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
        <div id="historyList">
        </div>
    </div>

    <script>
        // --- Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
        let expChartInstance = null;
        let incChartInstance = null;

        let db = {
            salary: 0,
            transactions: []
        };

        window.onload = function() {
            let savedData = localStorage.getItem('myMoneyApp_v2'); // ØºÙŠØ±Øª Ø§Ù„Ø§Ø³Ù… Ù„Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
            if (savedData) {
                db = JSON.parse(savedData);
                document.getElementById('salaryInput').value = db.salary > 0 ? db.salary : '';
            }
            document.getElementById('inpDate').valueAsDate = new Date();
            refreshUI();
        };

        function toggleLists() {
            const isIncome = document.getElementById('radioInc').checked;
            const listExp = document.getElementById('listExpense');
            const listInc = document.getElementById('listIncome');

            if (isIncome) {
                listExp.classList.add('hide');
                listInc.classList.remove('hide');
            } else {
                listExp.classList.remove('hide');
                listInc.classList.add('hide');
            }
        }

        function addTransaction() {
            const amountVal = document.getElementById('inpAmount').value;
            if (!amountVal) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ÙˆÙ„!");

            const isIncome = document.getElementById('radioInc').checked;
            
            let categoryVal;
            if (isIncome) {
                categoryVal = document.getElementById('listIncome').value;
            } else {
                categoryVal = document.getElementById('listExpense').value;
            }

            const newTrans = {
                id: Date.now(),
                type: isIncome ? 'income' : 'expense',
                amount: parseFloat(amountVal),
                category: categoryVal,
                date: document.getElementById('inpDate').value
            };

            db.transactions.push(newTrans);
            saveData();
            
            document.getElementById('inpAmount').value = '';
            refreshUI();
        }

        function deleteItem(id) {
            if (confirm("Ø£ÙƒÙŠØ¯ Ø¹Ø§ÙŠØ² ØªÙ…Ø³Ø­ØŸ")) {
                db.transactions = db.transactions.filter(t => t.id !== id);
                saveData();
                refreshUI();
            }
        }

        function saveData() {
            const sal = document.getElementById('salaryInput').value;
            db.salary = sal ? parseFloat(sal) : 0;
            localStorage.setItem('myMoneyApp_v2', JSON.stringify(db));
            refreshUI();
        }

        function refreshUI() {
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = '';

            let totalInc = 0;
            let totalExp = 0;

            const reversed = [...db.transactions].reverse();
            
            reversed.forEach(t => {
                if(t.type === 'income') totalInc += t.amount;
                else totalExp += t.amount;

                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <div>
                        <strong>${t.category}</strong> <br>
                        <small style="color:#777">${t.date}</small>
                    </div>
                    <div>
                        <span class="${t.type === 'income' ? 'money-plus' : 'money-minus'}">
                            ${t.type === 'income' ? '+' : '-'} ${t.amount}
                        </span>
                        <button class="del-btn" onclick="deleteItem(${t.id})">x</button>
                    </div>
                `;
                listDiv.appendChild(row);
            });

            document.getElementById('showIncome').innerText = totalInc;
            document.getElementById('showExpense').innerText = totalExp;
            
            const net = (db.salary + totalInc) - totalExp;
            document.getElementById('showNet').innerText = net;
            
            const bigBal = document.getElementById('finalBalance');
            bigBal.innerText = net + ' Ø¬.Ù…';
            bigBal.style.color = net >= 0 ? '#198754' : '#dc3545';

            // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
            updateCharts();
        }

        function clearAll() {
            if(confirm("Ù‡ØªÙ…Ø³Ø­ ÙƒÙ„ Ø­Ø§Ø¬Ø© ÙˆØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±ØŸ")) {
                localStorage.removeItem('myMoneyApp_v2');
                location.reload();
            }
        }

        // --- Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ¬Ù‡ÙŠØ² ÙˆØ±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        function updateCharts() {
            // 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let expTotals = {};
            let incTotals = {};

            db.transactions.forEach(t => {
                if(t.type === 'expense') {
                    expTotals[t.category] = (expTotals[t.category] || 0) + t.amount;
                } else {
                    incTotals[t.category] = (incTotals[t.category] || 0) + t.amount;
                }
            });

            // 2. Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø±Ø³Ù…
            function drawChart(canvasId, chartInstance, dataObj, colorBase, noDataId) {
                const labels = Object.keys(dataObj);
                const data = Object.values(dataObj);
                const ctx = document.getElementById(canvasId).getContext('2d');
                const noDataEl = document.getElementById(noDataId);

                // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ÙÙŠ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø©
                if(data.length === 0) {
                    document.getElementById(canvasId).style.display = 'none';
                    noDataEl.classList.remove('hide');
                    if(chartInstance) chartInstance.destroy();
                    return null;
                }

                // Ù„Ùˆ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¸Ù‡Ø± Ø§Ù„Ø±Ø³Ù…
                document.getElementById(canvasId).style.display = 'block';
                noDataEl.classList.add('hide');

                if (chartInstance) {
                    chartInstance.destroy(); // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…ÙŠØªØ±Ø§ÙƒÙ…Ø´
                }

                // Ø£Ù„ÙˆØ§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                let bgColors = labels.map(() => {
                   if(colorBase === 'red') return `hsl(${Math.random() * 50 + 330}, 70%, 60%)`; // Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ù…Ø±
                   return `hsl(${Math.random() * 60 + 100}, 60%, 50%)`; // Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø£Ø®Ø¶Ø±
                });

                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: bgColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø³Ù…
            expChartInstance = drawChart('expenseChart', expChartInstance, expTotals, 'red', 'noExpData');
            incChartInstance = drawChart('incomeChart', incChartInstance, incTotals, 'green', 'noIncData');
        }
    </script>

</body>
</html>